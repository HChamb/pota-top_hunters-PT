<script>
const PROXY = "https://pota-proxy.henrique-chambel.workers.dev/?url=";

// DXCC: CT, CU, CT3
const DXCCS = [272, 273, 256];

async function carregar() {
    const ano = document.getElementById('ano').value;
    const status = document.getElementById('status');
    const lista = document.getElementById('lista');
    const tabela = document.getElementById('tabela');

    status.style.display = 'block';
    tabela.style.display = 'none';
    lista.innerHTML = '';
    status.innerText = "A carregar dados do POTA...";

    let resultados = [];

    try {
        for (const id of DXCCS) {

            // Construção correta da URL
            const apiURL = ano
                ? `https://api.pota.app/leaderboard/hunter/${id}?year=${ano}`
                : `https://api.pota.app/leaderboard/hunter/${id}`;

            const response = await fetch(PROXY + encodeURIComponent(apiURL));

            if (!response.ok) {
                console.warn("Falha no DXCC", id);
                continue;
            }

            const data = await response.json();
            if (Array.isArray(data)) resultados = resultados.concat(data);
        }

        if (resultados.length === 0) {
            status.innerText = "Sem dados disponíveis para este ano.";
            return;
        }

        // Remover duplicados e somar counts
        const mapa = new Map();
        resultados.forEach(h => {
            if (!mapa.has(h.callsign)) mapa.set(h.callsign, { ...h });
            else mapa.get(h.callsign).count += h.count;
        });

        const final = [...mapa.values()].sort((a, b) => b.count - a.count);

        // Construção eficiente do HTML
        let html = "";
        final.slice(0, 50).forEach((h, i) => {
            html += `
                <tr>
                    <td>${i + 1}</td>
                    <td class="callsign">${h.callsign}</td>
                    <td class="count">${h.count}</td>
                </tr>`;
        });

        lista.innerHTML = html;
        status.style.display = 'none';
        tabela.style.display = 'table';

    } catch (e) {
        console.error(e);
        status.innerText = "Erro ao contactar o Worker ou API.";
    }
}

carregar();
</script>
